<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Value-only Attention Viewer (static tiles)</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;margin:16px;color:#222}
  h1{margin:0 0 8px 0;font-size:20px}
  .muted{color:#777;font-size:13px}
  .controls{display:grid;grid-template-columns:repeat(4,minmax(200px,1fr));gap:12px;margin:12px 0 16px 0}
  .row{margin:12px 0}
  .base-image{max-width:100%;height:auto;border:1px solid #ddd;border-radius:8px}
  #tiles{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px;margin-top:12px}
  .tile{border:1px solid #e0e0e0;border-radius:10px;padding:8px;box-shadow:0 1px 4px rgba(0,0,0,.05);background:#fff}
  .cap{font-size:12px;color:#555;margin:4px 0 8px 0;line-height:1.2}
  .thumb{width:100%;height:auto;display:block;border-radius:6px}
  .error{color:#b00020;white-space:pre-wrap}
  select,option{font-size:14px}
</style>
</head>
<body>
  <h1>Value-only Attention Viewer</h1>
  <div class="muted">
    Choose image (triplet), dataset, layer (0..27), and mode (shape/color/both).
    Uses pre-baked tiles under <code>static_tiles/</code>. Captions are text-only (not drawn on images).
  </div>

  <div class="controls">
    <label><div>Image (triplet id)</div><select id="sel-image"></select></label>
    <label><div>Dataset</div><select id="sel-ds"></select></label>
    <label><div>Layer</div><select id="sel-layer"></select></label>
    <label><div>Value mode</div>
      <select id="sel-mode">
        <option value="both">both (average of shape &amp; color)</option>
        <option value="shape">shape only</option>
        <option value="color">color only</option>
      </select>
    </label>
  </div>

  <div class="row">
    <img id="base" class="base-image" alt="base image"/>
  </div>

  <div id="tiles"></div>

<script>
const TILES_BASE = ".";  // folder with manifest.json + tiles
let MANI = null;

function byNumericKeys(obj){ return Object.keys(obj).sort((a,b)=>Number(a)-Number(b)); }

async function loadManifest(){
  const url = `${TILES_BASE}/manifest.json`;
  const resp = await fetch(url, {cache:"no-store"});
  if(!resp.ok) throw new Error(`Cannot load manifest.json (${resp.status})`);
  MANI = await resp.json();
}

function fillSelectors(){
  const selDs = document.getElementById("sel-ds");
  const selImg= document.getElementById("sel-image");
  const selL  = document.getElementById("sel-layer");

  selDs.innerHTML = ""; selImg.innerHTML = ""; selL.innerHTML = "";

  const datasets = Object.keys(MANI.entries);
  datasets.forEach(ds => { const o=document.createElement("option"); o.value=ds; o.textContent=ds; selDs.appendChild(o); });
  selDs.selectedIndex = 0;

  const firstDs = selDs.value;
  byNumericKeys(MANI.entries[firstDs]).forEach(t => { const o=document.createElement("option"); o.value=t; o.textContent=t; selImg.appendChild(o); });

  for(let i=0;i<28;i++){ const o=document.createElement("option"); o.value=i; o.textContent=String(i); selL.appendChild(o); }
  selL.value = "14";

  selDs.addEventListener("change", onDsChange);
  selImg.addEventListener("change", render);
  selL.addEventListener("change", render);
  document.getElementById("sel-mode").addEventListener("change", render);
}

function onDsChange(){
  const ds = document.getElementById("sel-ds").value;
  const selImg= document.getElementById("sel-image");
  selImg.innerHTML = "";
  byNumericKeys(MANI.entries[ds]).forEach(t => { const o=document.createElement("option"); o.value=t; o.textContent=t; selImg.appendChild(o); });
  render();
}

function render(){
  const ds    = document.getElementById("sel-ds").value;
  const trip  = document.getElementById("sel-image").value;
  const layer = Number(document.getElementById("sel-layer").value);
  const mode  = document.getElementById("sel-mode").value;

  const entry = (MANI.entries[ds]||{})[trip];
  const tilesDiv = document.getElementById("tiles");
  tilesDiv.classList.remove("error");
  tilesDiv.textContent = "";

  if(!entry){ tilesDiv.classList.add("error"); tilesDiv.textContent="No entry for this dataset/image."; return; }

  document.getElementById("base").src = `${TILES_BASE}/${entry.base}`;

  const sel = entry.tiles.filter(t => t.mode===mode && t.layer===layer).sort((a,b)=>a.pair-b.pair);
  if(!sel.length){ tilesDiv.classList.add("error"); tilesDiv.textContent="No tiles for this selection."; return; }

  for(const t of sel){
    const wrap = document.createElement("div"); wrap.className = "tile";
    const cap  = document.createElement("div"); cap.className = "cap";
    cap.textContent = `${t.pair}. shape=${t.shape}, color=${t.color} â€” layer ${t.layer}`;
    const img  = document.createElement("img"); img.className = "thumb";
    img.loading = "lazy";
    img.src = `${TILES_BASE}/${t.file}`;
    img.alt = cap.textContent;
    wrap.appendChild(cap);
    wrap.appendChild(img);
    tilesDiv.appendChild(wrap);
  }
}

(async function init(){
  try{
    await loadManifest();
    fillSelectors();
    render();
  }catch(e){
    const tilesDiv = document.getElementById("tiles");
    tilesDiv.classList.add("error");
    tilesDiv.textContent = String(e && e.message ? e.message : e);
  }
})();
</script>
</body>
</html>
